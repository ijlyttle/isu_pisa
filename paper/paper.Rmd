Seven Things That Affect Education Around the World
========================================================

Luke Fostveldt, Alex Shum, Ian Lyttle, Di Cook

Reducing inequities in education outcomes is of great interest to politicians. Dissecting the causes of inequality is a much tougher challenge with no panacea. Nonetheless, tackling inequality in educational outcomes is essential from both moral and economic viewpoints. The Programme for International Student Assessment (PISA) is a triennial survey conducted by the Organization for Economic Cooperation and Development (OECD) with a rotating additional emphasis on one of mathematics, reading, and science. In 2012, the additional emphasis was on mathematics. All 34 member countries of the OECD and 31 partnering countries and economies participated in the survey. This represents over 80% of the global economy. The OECD estimates that if all students could reach a level-2 proficiency in mathematics -- a level-2 proficiency means that a student can only handle the ``simplest and most obvious tasks" -- it would add a collective US$200 trillion to the world's collective GDP. 

The OECD describes the PISA survey as ``the world's global metric for quality, equity and efficiency in school education" (citep[p. 3]{PISA2014a}). The goal of the PISA survey is to assess the workforce readiness of 15-year old students. Nearly 500,000 students were tested across the 65 countries and economies. Students are examined on how well they can apply the knowledge they learned in school to applications outside of school. The scores reported range between 0-1000. Additional information about the students, parents, and schools is also collected. The students completed a questionnaire providing information about themselves, their homes, their schools, and a variety of psychological views regarding factors they believe affects their performance in school. Schools principals responded to a questionnaire covering the school system and learning experiences for students. In some countries, parents completed a questionnaire requesting information about their perceptions regarding the school system, expectations for their child, and their involvement in their child's schooling.  

The data was made available by the OECD as part of a data challenge for the useR! 2014 conference. Entries to the competition can be found at http://beta.icm.edu.pl/PISAcontest/. We learned a lot from this data, and won one of the prizes. This is a description of the seven main things we learned about 15 year olds, their math, science and reading skills, and the effects of other factors.

```{r read_me, echo = FALSE}
# Some notes for we authours:
# 
# * If you want to run this code interactively, change your working directory to
# `paper`.
# 
# * If there are packges we are all using, let's load them all once, in the
# load_packages chunk.
# 
# * If there are packages particular to your section, please consider loading
# them there, then detaching at the end of your section.
# 
# * I am being a bit presumptuous by leaving stringr loaded - maybe it makes
# sense to detach it. I'm sure we'll figure out wich way to go with each of our
# loaded packages.
# 
# - IJL
```

```{r load_packages, echo = FALSE, message = FALSE, warning = FALSE, results='hide'}
library(dplyr)
library(stringr)
library(reshape2)
library(ggplot2)
library(lubridate)
library(ggvis)
library(maps)
library(ggmap)
library(htmltools)
library(rworldmap)
library (grid)    
library (scales)
library(doBy)
```

```{r load_data, echo = FALSE, message = FALSE, warning = FALSE, results='hide', cache=TRUE}
# This is the scaffolding to import the data
sets <- c("item", "parent", "school", "scoredItem", "student")

# function to build the file names
fn_build <- function(file_name){
 
  template <- c("2012.rda", "2012dict.rda")
  
  file_name %>% 
    vapply(str_join, template, template) %>% 
    file.path("..", "data", .)
}

# load the data
sets %>% fn_build %>% lapply(load, .GlobalEnv)

# clean
rm(fn_build, sets)

# function to convert to data-frames
fn_make_df <- function(named_vector){
  data.frame(
    variable = attr(named_vector, "names"),
    description = named_vector,
    row.names = NULL
  )
}

# there's a clever way to do this, but beyond me for naw
dict_item2012 <- fn_make_df(item2012dict) 
dict_parent2012 <- fn_make_df(parent2012dict) 
dict_school2012 <- fn_make_df(school2012dict) 
dict_scoredItem2012 <- fn_make_df(scoredItem2012dict) 
dict_student2012 <- fn_make_df(student2012dict) 

# clean
rm(fn_make_df)
#rm(item2012dict, parent2012dict, school2012dict, scoredItem2012dict, student2012dict)
dim(student2012)
length(table(student2012$STIDSTD))
```

```{r mapdata, echo = FALSE, message = FALSE, warning = FALSE, results='hide'}
# Produce the maps
extractPolygons <- function(shapes) {

  dframe <- ldply(1:length(shapes@polygons), function(i) {
    ob <- shapes@polygons[[i]]@Polygons
    dframe <- ldply(1:length(ob), function(j) {
      x <- ob[[j]]
      co <- x@coords
      data.frame(co, order=1:nrow(co), group=j)
    })
    dframe$region <- i
    dframe$name <- shapes@polygons[[i]]@ID
    dframe
  })
  # construct a group variable from both group and polygon:
  dframe$group <- interaction(dframe$region, dframe$group)
  
  dframe
}

# To get a blank background on map
new_theme_empty <- theme_bw()
new_theme_empty$line <- element_blank()
new_theme_empty$rect <- element_blank()
new_theme_empty$strip.text <- element_blank()
new_theme_empty$axis.text <- element_blank()
new_theme_empty$plot.title <- element_blank()
new_theme_empty$axis.title <- element_blank()
new_theme_empty$plot.margin <- structure(c(0, 0, -1, -1), unit = "lines", valid.unit = 3L, class = "unit")

world <- getMap(resolution = "low")
library(plyr)
world.polys <- extractPolygons(world)
detach("package:plyr")
```

*** We should decide on country names, to coordinate map info and the test data. This si some really ugly code to convert names to be the same between the two. Could be made cleaner, much cleaner!

```{r dataprep, echo = FALSE, message = FALSE, warning = FALSE}
colnames(student2012)[1] <- "name"
student2012$name <- as.character(student2012$name)
colnames(school2012)[1] <- "name"
school2012$name <- as.character(school2012$name)

fix_country = function(df) {
df$name = as.character(df$name)
df$name[df$name=="Serbia"] <- "Republic of Serbia"
df$name[df$name=="Korea"] <- "South Korea"
df$name[df$name=="Chinese Taipei"] <- "Taiwan"
df$name[df$name=="Slovak Republic"] <- "Slovakia"
df$name[df$name=="Russian Federation"] <- "Russia"
df$name[df$name=="Perm(Russian Federation)"] <- "Russia"
df$name[df$name=="Hong Kong-China"] <- "Hong Kong S.A.R."
df$name[df$name=="China-Shanghai"] <- "China"
df$name[df$name=="China-Macau"] <- "China"
df$name[df$name=="Connecticut (USA)"] <- "United States of America"
df$name[df$name=="Florida (USA)"] <- "United States of America"
df$name[df$name=="Massachusetts (USA)"] <- "United States of America"

df
}

# Now add data
#student2012$name[student2012$name=="Serbia"] <- "Republic of Serbia"
#student2012$name[student2012$name=="Korea"] <- "South Korea"
#student2012$name[student2012$name=="Chinese Taipei"] <- "Taiwan"
#student2012$name[student2012$name=="Slovak Republic"] <- "Slovakia"
#student2012$name[student2012$name=="Russian Federation"] <- "Russia"
#student2012$name[student2012$name=="Perm(Russian Federation)"] <- "Russia"
#student2012$name[student2012$name=="Hong Kong-China"] <- "Hong Kong S.A.R."
#student2012$name[student2012$name=="China-Shanghai"] <- "China"
#student2012$name[student2012$name=="China-Macau"] <- "China"
#student2012$name[student2012$name=="Connecticut (USA)"] <- "United States of America"
#student2012$name[student2012$name=="Florida (USA)"] <- "United States of America"
#student2012$name[student2012$name=="Massachusetts (USA)"] <- "United States of America"
student2012$ST06Q01 <- as.numeric(student2012$ST06Q01)
student2012$PV1MATH <- as.numeric(student2012$PV1MATH)
student2012$PV1READ <- as.numeric(student2012$PV1READ)
student2012$PV1SCIE <- as.numeric(student2012$PV1SCIE)
student2012$SENWGT_STU <- as.numeric(student2012$SENWGT_STU)
school2012 = fix_country(school2012)
student2012 = fix_country(student2012)
```

### Teachers, computers, and libraries at school make a difference in math scores

```{r shortages, echo = FALSE, message = FALSE, warning = FALSE}
school2012.sub = school2012[, c(1, 6, 34, 35, 40, 45, 46, 47, 48, 49, 50, 51)] #%>% select(name, SCHOOLID, SC11Q02, SC11Q03, SC14Q02, SC14Q07, SC14Q08, SC14Q09, SC14Q10, SC14Q11, SC14Q12, SC14Q13)
student2012.sub = student2012[, c(1, 6, 501, 541, 546, 634)] #%>% select(name, SCHOOLID, PV1MATH, PV1READ, PV1SCIE)

scores_by_school = summarise(group_by(student2012.sub, name, SCHOOLID), mmath = mean(PV1MATH), 
                                      mread = mean(PV1READ), msci = mean(PV1SCIE))


df = scores_by_school %>% left_join(school2012.sub)
df2 <- summarise(group_by(df, name, SC14Q02), mmath2 = mean(mmath))
qplot(SC14Q02, mmath2, data = df2, facets = ~name)
df3 <- summarise(group_by(df, name, SC14Q10), mmath2 = mean(mmath))
qplot(SC14Q10, mmath2, data = df3, facets = ~name)
```


### The gender gap in math is not universal but the reading gap is, in favor of girls

For each country, average scores on math and reading are calculated separately for boys and girls. These averages are differenced to compute the "gap" between boys and girls. T-statistics were calculated to determine the statistical significance of the difference. The results are plotted in the graphs below. Each dot corresponds to a difference between girls and boys scores, for each country. Color indicates statistical significance (blue in favor of boys, pink in favor of girls and green means there was no significant difference). The size of the dot indicates the proportion of boys in the sample size. For most countries it is roughly equal, but some countries have an imblance, for example, Malaysia has more girls tested than boys. The maps color the countries by the presence of a gender gap.

The countries are sorted from biggest gap to smallest gap. Most countries have a gender gap in math scores in favor of boys. Colombia has the biggest gender gap, about 30 points on average boys do better than girls. It should be noted that this is small, though, because this 30 points is out of a possible 1000 points.  Four countries have gender gaps in favor of girls, and even more surprising, these are middle eastern, or Muslim countries. 

Conversely, though, when we look at reading scores the story is entirely different. Universally, girls score significantly better than boys. Again, the size of the gap is small, between 10 and 80 points. 

Although, not shown here, it also should be noted that this is the difference between the average scores for boys and girls. There is a slightly different story for each country if we look at the top math score for each geneder only, where we would notice that the top score in the USA is achieved by a girl, and is substantially higher than the highest boys score. There is far more individual variability than the overall average differences. 

```{r gendermath, fig.width=8, fig.height=12, warning=FALSE, message=FALSE, echo=FALSE}
student2012.sub <- student2012[, c(1, 12, 501, 541, 546, 634)]
colnames(student2012.sub)[1] <- "name"
student2012.sub$PV1MATH <- as.numeric(student2012.sub$PV1MATH)
student2012.sub$PV1READ <- as.numeric(student2012.sub$PV1READ)
student2012.sub$PV1SCIE <- as.numeric(student2012.sub$PV1SCIE)
student2012.sub$SENWGT_STU <- as.numeric(student2012.sub$SENWGT_STU)
student2012.sub.summary.gap <- summarise(group_by(student2012.sub, name), 
                  mathgap=mean(PV1MATH[ST04Q01=="Male"], na.rm=T)-
                          mean(PV1MATH[ST04Q01=="Female"], na.rm=T),
                  wmathgap=weighted.mean(PV1MATH[ST04Q01=="Male"], w=SENWGT_STU[ST04Q01=="Male"], na.rm=T)-
                          weighted.mean(PV1MATH[ST04Q01=="Female"], w=SENWGT_STU[ST04Q01=="Female"], na.rm=T),
                  mtest.stat = t.test(PV1MATH[ST04Q01=="Male"], PV1MATH[ST04Q01=="Female"])$statistic, 
                  mp.value = t.test(PV1MATH[ST04Q01=="Male"], PV1MATH[ST04Q01=="Female"])$p.value,
                  readgap=mean(PV1READ[ST04Q01=="Male"], na.rm=T)-mean(PV1READ[ST04Q01=="Female"], na.rm=T),
                  rtest.stat = t.test(PV1READ[ST04Q01=="Male"], PV1READ[ST04Q01=="Female"])$statistic, 
                  rp.value = t.test(PV1READ[ST04Q01=="Male"], PV1READ[ST04Q01=="Female"])$p.value,
                  sciencegap=mean(PV1SCIE[ST04Q01=="Male"], na.rm=T)-mean(PV1SCIE[ST04Q01=="Female"], na.rm=T),
                  stest.stat = t.test(PV1SCIE[ST04Q01=="Male"], PV1SCIE[ST04Q01=="Female"])$statistic, 
                  sp.value = t.test(PV1SCIE[ST04Q01=="Male"], PV1SCIE[ST04Q01=="Female"])$p.value,                                         
                  minmale=min(PV1MATH[ST04Q01=="Male"], na.rm=T), 
                  minfemale=min(PV1MATH[ST04Q01=="Female"], na.rm=T), 
                  maxmale=max(PV1MATH[ST04Q01=="Male"], na.rm=T), 
                  maxfemale=max(PV1MATH[ST04Q01=="Female"], na.rm=T), 
                  propmale=length(PV1MATH[ST04Q01=="Male"])/length(PV1MATH), 
                  propfemale=length(PV1MATH[ST04Q01=="Female"])/length(PV1MATH))
#qplot(mathgap, wmathgap, data=student2012.sub.summary.gap, xlab="Mean", ylab="Weighted Mean",
#      xlim=c(-30,30), ylim=c(-30,30)) + geom_abline(slope=1) + theme(aspect.ratio=1)
student2012.sub.summary.gap$msig <- ifelse(student2012.sub.summary.gap$mp.value>0.05, "none", TRUE)
student2012.sub.summary.gap$msig[student2012.sub.summary.gap$msig==TRUE&student2012.sub.summary.gap$mtest.stat>0] <- "male"
student2012.sub.summary.gap$msig[student2012.sub.summary.gap$msig==TRUE&student2012.sub.summary.gap$mtest.stat<0] <- "female"
student2012.sub.summary.gap$name <- factor(student2012.sub.summary.gap$name, 
      levels=student2012.sub.summary.gap$name[order(student2012.sub.summary.gap$mathgap)])
qplot(name, mathgap, data=student2012.sub.summary.gap, size=propmale, color=msig) + 
  xlab("") +
  scale_colour_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
  scale_y_continuous("Math Score Gap", breaks=seq(-30, 30, 5)) + 
  scale_size("Prop male") +
   geom_hline(yintercept=0, colour="grey80") + coord_flip() + theme_bw() + theme(legend.position="bottom")
#student2012.sub.summary.gap$name <- factor(student2012.sub.summary.gap$name, 
#      levels=student2012.sub.summary.gap$name[order(student2012.sub.summary.gap$maxmale)])
#qplot(name, maxmale, data=student2012.sub.summary.gap, color=I("skyblue")) + 
#  xlab("") +
#  geom_point(aes(y=maxfemale), colour="pink") + 
#  scale_y_continuous("High Math") + coord_flip() + theme_bw()
#ggsave("gendermathtop.pdf", width=3.5, height=7)
#student2012.sub.summary.gap$name <- factor(student2012.sub.summary.gap$name, 
#      levels=student2012.sub.summary.gap$name[order(student2012.sub.summary.gap$minfemale)])
#qplot(name, minmale, data=student2012.sub.summary.gap, color=I("skyblue")) + 
#  xlab("") +
#  geom_point(aes(y=minfemale), colour="pink") + 
#  scale_y_continuous("Low Math") + coord_flip() + theme_bw()
#ggsave("gendermathbottom.pdf", width=3.5, height=7)
#
student2012.sub.summary.gap$rsig <- ifelse(student2012.sub.summary.gap$rp.value>0.05, "none", TRUE)
student2012.sub.summary.gap$rsig[student2012.sub.summary.gap$rsig==TRUE&student2012.sub.summary.gap$rtest.stat>0] <- "male"
student2012.sub.summary.gap$rsig[student2012.sub.summary.gap$rsig==TRUE&student2012.sub.summary.gap$rtest.stat<0] <- "female"
student2012.sub.summary.gap$name <- factor(student2012.sub.summary.gap$name, 
      levels=student2012.sub.summary.gap$name[order(student2012.sub.summary.gap$readgap)])
qplot(name, readgap, data=student2012.sub.summary.gap, size=propmale, color=rsig) + 
  xlab("") +
  scale_colour_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
  scale_y_continuous("Reading Score Gap") + 
  scale_size("Prop male") +
   geom_hline(yintercept=0, colour="grey80") + coord_flip() + theme_bw() + theme(legend.position="bottom")
#ggsave("genderreadgap.pdf", width=5, height=8)
#student2012.sub.summary.gap$ssig <- ifelse(student2012.sub.summary.gap$sp.value>0.05, "none", TRUE)
#student2012.sub.summary.gap$ssig[student2012.sub.summary.gap$ssig==TRUE&student2012.sub.summary.gap$stest.stat>0] <- "male"
#student2012.sub.summary.gap$ssig[student2012.sub.summary.gap$ssig==TRUE&student2012.sub.summary.gap$stest.stat<0] <- "female"
#student2012.sub.summary.gap$name <- factor(student2012.sub.summary.gap$name, 
#      levels=student2012.sub.summary.gap$name[order(student2012.sub.summary.gap$sciencegap)])
#qplot(name, sciencegap, data=student2012.sub.summary.gap, size=propmale, color=ssig) + 
#  xlab("") +
#  scale_colour_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
#  scale_y_continuous("Science Score Gap") + 
#  scale_size("Prop male") +
#   geom_hline(yintercept=0, colour="grey80") + coord_flip() + theme_bw()
```

```{r gendermaps, fig.width=12, fig.height=7, warning=FALSE, message=FALSE, echo=FALSE}
student2012.sub.map <- left_join(student2012.sub.summary.gap, world.polys)
ggplot(data=world.polys) + geom_path(aes(x=X1, y=X2, order=order, group=group), colour=I("grey90")) + 
  geom_polygon(data=student2012.sub.map, aes(x=X1, y=X2, order=order, group=group, fill=msig)) +
  scale_fill_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
  new_theme_empty + theme(legend.position="none")
#ggsave("gendermathmap.pdf", width=12, height=7)
ggplot(data=world.polys) + geom_path(aes(x=X1, y=X2, order=order, group=group), colour=I("grey90")) + 
  geom_polygon(data=student2012.sub.map, aes(x=X1, y=X2, order=order, group=group, fill=rsig)) +
  scale_fill_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
  new_theme_empty + theme(legend.position="none")
#ggsave("genderreadmap.pdf", width=12, height=7)
#ggplot(data=world.polys) + geom_path(aes(x=X1, y=X2, order=order, group=group), colour=I("grey90")) + 
#  geom_polygon(data=student2012.sub.map, aes(x=X1, y=X2, order=order, group=group, fill=ssig)) +
#  scale_fill_manual("Significant", values=c("male"="skyblue", "female"="pink", "none"="lightgreen")) +
#  new_theme_empty + theme(legend.position="none")
```

### Starting school at an older age generated lower average math score. 

For each country we have computed the average math test score by age that the children started school. In additon, for each country we computed the median age that children in the study started school. There are differences in typical school start age between countries. Ireland has the youngest median start age - children head to school at age 4. Britain, and its past colonies, Australia, Canada and New Zealand, have a median start age of 5. For many other countries the median start age is 6, and for northern Europe, much of Asia and Brazil median start age is as late as 7. Some countries appear to have rigid starting ages, eg in Japan all children start at age 6.

Within a country, looking at the average math score for each start age, the score typically declines, especially after age 6. This is almost uniformly the pattern across all of the countries in the study. For several countries - Russia, Denmark, Bulgaria - if a child starts school at age 4 their math scores were much better on average than another other starting age group. School start age matters, that children need to start school in the 4-6 age range to expect better math scores, on average. 

```{r age, fig.width=10, fig.height=12, echo = FALSE, message = FALSE, warning = FALSE}
student2012.sub <- student2012[, c(1, 6, 12, 14, 501, 541, 546, 634)]
student2012.sub.age <- summarise(group_by(student2012.sub, name), 
                  math4 = mean(PV1MATH[ST06Q01 == 4], na.rm = T), 
                  math5 = mean(PV1MATH[ST06Q01 == 5], na.rm = T), 
                  math6 = mean(PV1MATH[ST06Q01 == 6], na.rm = T), 
                  math7 = mean(PV1MATH[ST06Q01 == 7], na.rm = T), 
                  math8 = mean(PV1MATH[ST06Q01 >  7], na.rm = T))
student2012.sub.age.m <- melt(student2012.sub.age)
student2012.sub.age.m$variable <- substr(student2012.sub.age.m$variable, 5, 5)
student2012.sub.age.m$variable <- as.numeric(student2012.sub.age.m$variable)
student2012.sub.agemedian <- summarise(group_by(student2012.sub, name), medianstart = median(ST06Q01, na.rm=T))
orderedbymedianage <- student2012.sub.agemedian$name[order(student2012.sub.agemedian$medianstart)]
student2012.sub.age.m.median <- left_join(student2012.sub.age.m, student2012.sub.agemedian)
student2012.sub.age.m.median$medianstart <- factor(student2012.sub.age.m.median$medianstart)
student2012.sub.age.m.median$name <- factor(student2012.sub.age.m.median$name, levels=orderedbymedianage)
qplot(variable, value, data=student2012.sub.age.m.median, xlab="Age at start", ylab="Math Score", 
      geom=c("point","smooth"), se=F, group=name, colour=medianstart) + 
 facet_wrap(~name, ncol=8) + theme_bw() + theme(legend.position="none")
# ggsave("school-start.pdf", width=14, height=14)
#student2012.sub.age <- summarise(group_by(student2012.sub, name), 
#                  read4 = mean(PV1READ[ST06Q01 == 4], na.rm = T), 
#                  read5 = mean(PV1READ[ST06Q01 == 5], na.rm = T), 
#                  read6 = mean(PV1READ[ST06Q01 == 6], na.rm = T), 
#                  read7 = mean(PV1READ[ST06Q01 == 7], na.rm = T), 
#                  read8 = mean(PV1READ[ST06Q01 >  7], na.rm = T))
#student2012.sub.age.m <- melt(student2012.sub.age)
#student2012.sub.age.m$variable <- substr(student2012.sub.age.m$variable, 5, 5)
#student2012.sub.age.m$variable <- as.numeric(student2012.sub.age.m$variable)
#qplot(variable, value, data=student2012.sub.age.m, xlab="Age at start", ylab="Reading Score", 
#      geom=c("point","smooth"), se=F, group=name) + 
# facet_wrap(~name, ncol=8) + theme_bw() 
#student2012.sub.age <- summarise(group_by(student2012.sub, name), 
#                  scie4 = mean(PV1SCIE[ST06Q01 == 4], na.rm = T), 
#                  scie5 = mean(PV1SCIE[ST06Q01 == 5], na.rm = T), 
#                  scie6 = mean(PV1SCIE[ST06Q01 == 6], na.rm = T), 
#                  scie7 = mean(PV1SCIE[ST06Q01 == 7], na.rm = T), 
#                  scie8 = mean(PV1SCIE[ST06Q01 >  7], na.rm = T))
#student2012.sub.age.m <- melt(student2012.sub.age)
#student2012.sub.age.m$variable <- substr(student2012.sub.age.m$variable, 5, 5)
#student2012.sub.age.m$variable <- as.numeric(student2012.sub.age.m$variable)
#qplot(variable, value, data=student2012.sub.age.m, xlab="Age at start", ylab="Science Score", 
#      geom=c("point","smooth"), se=F, group=name) + 
# facet_wrap(~name, ncol=8) + theme_bw() 
```

```{r agemaps, fig.width=12, fig.height=7, echo = FALSE, message = FALSE, warning = FALSE}
# Extract map polygons for modern world
world <- getMap(resolution = "low")
library(plyr)
world.polys <- extractPolygons(world)
detach("package:plyr")

student2012.sub.agemedian$medianstart <- factor(student2012.sub.agemedian$medianstart)
student2012.sub.map <- left_join(student2012.sub.agemedian, world.polys)
ggplot(data=world.polys) + geom_path(aes(x=X1, y=X2, order=order, group=group), colour=I("grey90")) + 
  geom_polygon(data=student2012.sub.map, aes(x=X1, y=X2, order=order, group=group, fill=medianstart)) +
  scale_fill_discrete("Median Start Age") +
  new_theme_empty + theme(legend.position="bottom")
#ggsave("agestartmap.pdf", width=12, height=7)
```
### Time spent out of school studying is important, but only up to a point

***Need to get this code working

```{r, eval=FALSE}
# Out of School Study time
b1 <- summaryBy(data=student2012, pvM + pvR + pvS+ ST57Q01+ ST57Q02 +ST57Q03+ ST57Q04+ ST57Q05+ ST57Q06 ~CNT,FUN=mean, na.rm=T)
names(b1) <- c("CNT","pvM","pvR","pvS","ST57Q01", "ST57Q02","ST57Q03", "ST57Q04", "ST57Q05", "ST57Q06" )
# Out of school study time (total hours HW)
b1$CNT <- reorder(factor(b1$CNT),b1$pvS, mean)
b2 <- melt(b1[,c("CNT","pvM","pvR","pvS")],id="CNT")
b2 <- cbind(b2, b1[match(b2$CNT,b1$CNT), 5:10])
qplot(CNT, value,color=variable,size=ST57Q01, data = b2)+ coord_flip()
head(b2)
qplot(ST57Q01, value,color=variable,size=ST57Q02, data = b2)+ coord_flip()+facet_wrap(~CNT)

student.sub <- studschool[,c("name","pvM","pvR","pvS","ST57Q01","OECD","SC03Q01")]
study <- melt(student.sub,id=c("name","ST57Q01","OECD","SC03Q01"))
names(study) <- c("Country","HomeworkHours","OECD","AREA","Subject","Score")
levels(study$Subject) <- c("Math","Reading","Science")
p <- ggplot(data = study, aes(HomeworkHours,Score,colour=Subject) )+xlim(0,20)+facet_wrap(~Country)+stat_smooth(se=F)+ xlab("Out-of-School Study Hours")
#ggsave(p,file="studytime.pdf",height=13,width=13)
p <- ggplot(data=student.sub, aes(ST57Q01, ..density..)) + geom_histogram(binwidth=5) + xlab("Out-of-School Study Hours") +xlim(0,30)
ggsave(p,file="HistHWschool.pdf",width=8,height=6)

student.sub <- studschool[,c("name","pvM","ST57Q01","SC03Q01")]
study <- student.sub
names(study) <- c("Country","Math","HomeworkHours","Schoolplace")

p <- ggplot(data = study, aes(HomeworkHours,Math,colour=Schoolplace) )+xlim(0,20)+facet_wrap(~Country)+stat_smooth(se=F)
#ggsave(p,file="studytime.pdf",height=13,width=13)
p <- ggplot(data=student.sub, aes(ST57Q01, ..density..)) + geom_histogram(binwidth=5) + xlab("Out-of-School Study Hours") + facet_grid(SC03Q01~.) +xlim(0,30)
```

### More TVs yield higher math scores in the developing world, but lower in the developed countries

One of the factors in the data is the number of televisions in the student's household. Possible values were: "zero", "one", "two", or "three or more". Because there were so (relatively) few observations of "zero", for this invesitgation, the "zero" and "one" categories were combined to form a "one or less" category.

A linear model is fitted the students of each country, using the math score as the dependent variable and the number of televisions as the independent variable (as an ordered factor). The direction and significance of the correlation was determined for each country. Significance is indicated by the p-value for a given regression being less than the conventional 0.05.

For many countries, a significant relationship was be found between math scores and number of household televisions. The interesting part was to notice that those countries with a significant *positive* relationship appear to include much of the developing world (with lower median-scores), while those countries with a significant *negative* relationship appear to include much of the developed world (with higher median-scores).

The figure below illustrates the relationship, along with another factor, student has a place to study. It is a complex diagram, but of interest is the middle column of plots - the boxplots overlaid on other information show the math scores of students relative to the number of TVs in the household, separately plotted for countries falling into one of three categories, negative, zero or  positive correlation. The white regions are violin plots of math scores by presence or absence of a place to study. A place to study universally leads to better math scores on average. The map is colored by correlation between number of TVs and math scores. The bar charts indicates sample size for the categories. The dot plots show average math scores by country, separately for each correlation group.

Although results shown here are for math only, a similar set of relationships is found using the reading and science scores. 

It seems that television is a great equalizer. 

!["TVs"](shiny-pisa.jpg)

### Parents matter

The role of parents in a child's education and success later in life is of great interest to both educators and policy makers. The relationship between eduational achievement and both household structure and parent's occupational status were evaluated. To look at the relationship between educational success and family structure, boxplots were made of the student's scores conditioned whether the student had a two-parent household, only a mother at home, only a father at home, or no parents at home. The relationship was evaluated for every participating country. The majority of the students did live in a two-parent household, but there were still sizable numbers of students who did not. The information regarding a parent's occupational was provided in a way that can be broadly catergorized with five catergories: "Full-employment", "Part-time", "Unemployed-looking for work", "Other: Home duties, retired, etc.", and "Missing". The means achievement in mathematics for each of the categories was calculated and plotted for each country. 

```{r par_athomebar, fig.width=10, fig.height=12, echo = FALSE, message = FALSE, warning = FALSE}
athome = student2012[,c("name", "SCHOOLID", "STIDSTD", "OECD", "PV1MATH", "PV1SCIE", "PV1READ","ST11Q01", "ST11Q02", "ST11Q03","ST11Q04", "ST11Q05", "ST11Q06")]
athome = filter(athome, !is.na(athome$ST11Q01) & !is.na(athome$ST11Q02))
athome$parents = NA
athome[athome$ST11Q01 == "Yes" & athome$ST11Q02 == "Yes", ]$parents = "Both"
athome[athome$ST11Q01 == "Yes" & athome$ST11Q02 == "No", ]$parents = "Mother"
athome[athome$ST11Q01 == "No" & athome$ST11Q02 == "Yes", ]$parents = "Father"
athome[athome$ST11Q01 == "No" & athome$ST11Q02 == "No", ]$parents = "Neither"
#athome$name <- reorder(athome$name, athome$PV1MATH, mean, decreasing=F)
#qplot(x = parents, data = athome) 
```

```{r par_athome, fig.width=10, fig.height=12, echo = FALSE, message = FALSE, warning = FALSE}
qplot(x = parents, y = PV1MATH, geom = "boxplot", outlier.size = 1, facets = ~name, data = athome) + coord_flip() + ylab("Math Scores") + xlab("Family Structure") 
```
### The weird and wacky republic of Albania

```{r clean, echo=FALSE}
student2012$CNT = student2012$name
student2012$OECD <- as.character(student2012$OECD)
student2012[student2012$CNT == "Albania", ]$OECD = "Albania"
student2012$math = as.numeric(student2012[, "PV1MATH"])
student2012$read = as.numeric(student2012[, "PV1READ"])
student2012$sci = as.numeric(student2012[, "PV1SCIE"])

student2012.sub = student2012 %>% dplyr::select(CNT, SCHOOLID, math, read, sci, OUTHOURS, STIDSTD, ST04Q01, ST11Q01, ST11Q02, ST15Q01, ST19Q01, ST26Q01, ST26Q02, ST26Q03, ST26Q04, ST26Q05, ST26Q06, ST26Q07, ST26Q08, ST26Q09, ST26Q10, ST26Q11, ST26Q12, ST26Q13, ST26Q14, ST27Q01, ST27Q02, ST27Q03, ST27Q04, ST27Q05, ST28Q01, OECD)

for (i in 13:26) {
    student2012.sub[, i] <- as.character(student2012.sub[, i])
    student2012.sub[is.na(student2012.sub[, i]), i] <- ""
    student2012.sub[student2012.sub[, i] == "Yes", i] <- "1"
    student2012.sub[student2012.sub[, i] == "No", i] <- "0"
    student2012.sub[, i] <- as.numeric(student2012.sub[, i])
}
for (i in 27:31) {
    student2012.sub[, i] <- as.character(student2012.sub[, i])
    student2012.sub[is.na(student2012.sub[, i]), i] <- ""
    student2012.sub[student2012.sub[, i] == "None", i] <- "0"
    student2012.sub[student2012.sub[, i] == "One", i] <- "1"
    student2012.sub[student2012.sub[, i] == "Two", i] <- "2"
    student2012.sub[student2012.sub[, i] == "Three or more", i] <- "3"
    student2012.sub[, i] <- as.numeric(student2012.sub[, i])
}
student2012.sub[, 32] <- as.character(student2012.sub[, 32])
student2012.sub[is.na(student2012.sub[,32]), 32] <- ""
student2012.sub[student2012.sub[, 32] == "0-10 books ", 32] <- "0"
student2012.sub[student2012.sub[, 32] == "11-25 books ", 32] <- "1"
student2012.sub[student2012.sub[, 32] == "26-100 books ", 32] <- "2"
student2012.sub[student2012.sub[, 32] == "101-200 books ", 32] <- "3"
student2012.sub[student2012.sub[, 32] == "201-500 books ", 32] <- "4"
student2012.sub[student2012.sub[, 32] == "More than 500 books", 32] <- "5"
student2012.sub[, 32] <- as.numeric(student2012.sub[, 32])

#aggregate possessions
student2012.sub$numposs <- apply(student2012.sub[, 13:26], 1, sum, na.rm = T)
student2012.sub$numedposs <- apply(student2012.sub[, 27:31], 1, sum, na.rm = T)
```

```{r albania-possessions, echo=FALSE}
df = melt(student2012.sub %>% group_by(CNT, numposs, OECD) %>% summarise(mmath = mean(math), msci = mean(sci), mread = mean(read)), id=c("CNT", "numposs", "OECD"))

df$group = paste0(df$CNT, df$variable)
qplot(x = numposs, y = value, data = df, facets = ~OECD, geom = "line", color = variable, group = group) + ylab("test scores") + xlab("number of possessions") + scale_colour_discrete(name = "Subject", labels=c("Math", "Science", "Reading"))
```

```{r truancyschool, echo=FALSE}
school2012$CNT = school2012$name
school2012.sub = school2012 %>% dplyr::select(CNT, SCHOOLID, SC22Q01)
student2012.sub = student2012 %>% dplyr::select(CNT, SCHOOLID, math, read, sci, OECD)
truancy.df = melt( student2012.sub %>% 
  group_by(CNT, SCHOOLID) %>% 
  left_join(school2012.sub, by = c("CNT", "SCHOOLID")) %>% 
  group_by(CNT, SC22Q01, OECD) %>% summarise(math = mean(math), read = mean(read), sci = mean(sci)), 
  id = c("CNT", "SC22Q01", "OECD")) %>% filter(!is.na(SC22Q01))
truancy.df$group = paste0(truancy.df$CNT, truancy.df$variable)

qplot(x = SC22Q01, y = value, color = variable, facets = ~OECD, data = truancy.df, group = group, geom = "line") + xlab("reported truancy") + ylab("test scores") + scale_colour_discrete(name = "Subject", labels=c("Math", "Science", "Reading"))
```

```{r studytime, warning = FALSE, message=FALSE, echo=FALSE}
.width = 1

data_small <- 
  student2012 %>%
  dplyr::select(OECD, CNT, OUTHOURS) %>%
  filter(!is.na(OUTHOURS))

ggplot(mapping = aes(x = OUTHOURS)) + 
  scale_x_continuous(name = "out of school study time (hours)", limits = c(0,60)) +
  scale_y_continuous(name = "density") +
  geom_histogram(
    mapping = aes(y = ..density.., fill = OECD), 
    binwidth = .width,
    data = data_small %>% filter(OECD == "Albania")
  ) + 
  scale_fill_manual(
    values = "black",
    breaks = "Albania",
    guide = guide_legend(title = "")
  ) + 
  geom_line(
    mapping = aes(group = CNT, color = OECD), 
    stat = "density", 
    alpha = 0.3,
    data = data_small %>% filter(OECD != "Albania")
  ) +
  scale_color_discrete(
    guide = guide_legend(
      title = "Other Countries",
      override.aes = list(alpha = 1)
    )
    
  ) +
  scale_colour_manual(values = c("#f4a582", "#92c5de")) + guides(colour = guide_legend(override.aes = list(alpha = 1)))
```

```{r gendergap, echo=FALSE, warning = FALSE, fig.height = 10}
scores = student2012 %>%
  dplyr::select(CNT, math, read, ST04Q01, OECD) %>% 
  group_by(OECD, CNT, ST04Q01) %>%
  summarise(math = mean(math), read = mean(read))
male = scores %>% filter(ST04Q01 == "Male")
female = scores %>% filter(ST04Q01 == "Female")
scores.df = data.frame(OECD = male$OECD, CNT = male$CNT, math_difference = male$math - female$math, read_difference = male$read - female$read)


scores.df$CNT = factor(scores.df$CNT, levels = scores.df$CNT[order(scores.df$math_difference)])
scores.df$OECD = factor(scores.df$OECD, levels = scores.df$OECD[])

qplot(CNT, math_difference, data = scores.df, color = OECD, size = OECD) + coord_flip() +
  scale_y_continuous("math score gap: male - female scores", breaks=seq(-30, 30, 5)) +
  geom_hline(yintercept=0, colour="grey80") + scale_size_manual(values = c(4, 2.5, 2.5)) + xlab("") +  
  scale_colour_manual(values = c("#ca0020", "#f4a582", "#92c5de"))

scores.df$CNT = factor(scores.df$CNT, levels = scores.df$CNT[order(scores.df$read_difference)])
qplot(CNT, read_difference, data = scores.df, color = OECD, size = OECD) + coord_flip() +
  scale_y_continuous("read score gap: male - female scores") +
  geom_hline(yintercept=0, colour="grey80") + scale_size_manual(values = c(4, 2.5, 2.5)) + xlab("") +  
  scale_colour_manual(values = c("#ca0020", "#f4a582", "#92c5de"))
```

### Play with the data yourself

The PISA dataset contains hundreds of factors, and this article can describe just a few findings. The reader is welcome to explore the data themselves using an <a href="http://bit.ly/pisa2012_explorer"> interactive web tool</a>, made with <a href="http://www.rstudio.com">RStudio</a> and Shiny. Shiny is a open-source tool, developed by RStudio, that allows an investigator to create a web-based appication powered by R. 

### Acknowledgements

Shiny, by RStudio

plyr, dplyr, and ggplot2, by Hadley Wickham
